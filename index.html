--- START OF FILE index.html ---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Associology</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { overscroll-behavior: none; }
        .cell-selected {
            background: #3B82F6 !important;
            border-color: #2563EB !important;
            transform: scale(0.95);
        }
        .locked-cell {
            background: linear-gradient(135deg, #86efac, #22c55e) !important;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0) translate(-50%, -50%); }
            to { opacity: 1; transform: scale(1) translate(-50%, -50%); }
        }
        .quadrant-icon-appear {
            animation: fadeInScale 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }
        .safe-bottom {
            padding-bottom: max(12px, env(safe-area-inset-bottom, 12px));
        }
        .cell-number {
            position: absolute;
            top: 3px;
            left: 5px;
            font-size: 12px;
            font-weight: 700;
            opacity: 0.8;
            z-index: 10;
        }
        .header-number-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1px;
            font-size: 8px;
            font-weight: 700;
            opacity: 0.6;
            background: rgba(0,0,0,0.05);
            padding: 2px;
            border-radius: 4px;
            margin-left: auto;
            text-align: center;
            line-height: 1.1;
            flex-shrink: 0;
            width: 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const FIXED_QUADRANTS = true;

        const QUADRANT_NUMBERS = [
            [1, 2, 4, 5], // TL
            [2, 3, 5, 6], // TR
            [4, 5, 7, 8], // BL
            [5, 6, 8, 9]  // BR
        ];

        const PUZZLES = [
            {
                id: 1,
                title: "Torque n' Talk",
                titleIcon: "ðŸš—",
                centerWord: "DRIVE",
                solutions: [["WHEEL","CRASH","MOUSE","STEER","DRIVE","EJECT","WRANGLE","CULL","REPEL"]],
                allWords: ["WHEEL","CRASH","MOUSE","STEER","EJECT","WRANGLE","CULL","REPEL"],
                quadrantClues: [
                    { clue: "VEHICLES", words: ["WHEEL","CRASH","STEER","DRIVE"], icon: "ðŸš—" },
                    { clue: "COMPUTERS", words: ["CRASH","MOUSE","DRIVE","EJECT"], icon: "ðŸ’»" },
                    { clue: "CATTLE HERDING", words: ["STEER","WRANGLE","CULL","DRIVE"], icon: "ðŸ¤ " },
                    { clue: "REMOVAL", words: ["REPEL","CULL","EJECT","DRIVE"], icon: "ðŸš«" }
                ],
                explanations: { "DRIVE": { "VEHICLES": "Operate vehicle", "COMPUTERS": "Storage device", "CATTLE HERDING": "Herd cattle", "REMOVAL": "Drive out" }, "WHEEL": "Vehicle part", "CRASH": { "VEHICLES": "Vehicle accident", "COMPUTERS": "System failure" }, "MOUSE": "Input device", "STEER": { "VEHICLES": "Guide vehicle", "CATTLE HERDING": "Male bovine" }, "EJECT": { "COMPUTERS": "Eject disk", "REMOVAL": "Expel" }, "WRANGLE": "Round up cattle", "CULL": { "CATTLE HERDING": "Reduce herd", "REMOVAL": "Weed out" }, "REPEL": "Drive back" }
            },
            {
                id: 2, title: "Fasten the Forecast", titleIcon: "â›ˆï¸", centerWord: "BOLT",
                solutions: [["AXLE","SPRING","DASH","PIN","BOLT","SURGE","SEAM","EYE","HAIL"]],
                allWords: ["AXLE","SPRING","DASH","PIN","SURGE","SEAM","EYE","HAIL"],
                quadrantClues: [{ clue: "MECHANICAL", words: ["AXLE","SPRING","PIN","BOLT"], icon: "ðŸ”©" }, { clue: "SUDDEN MOVEMENT", words: ["SPRING","DASH","BOLT","SURGE"], icon: "ðŸƒ" }, { clue: "SEWING", words: ["PIN","BOLT","SEAM","EYE"], icon: "ðŸ§µ" }, { clue: "STORM", words: ["BOLT","SURGE","EYE","HAIL"], icon: "â›ˆï¸" }],
                explanations: { "BOLT": { "MECHANICAL": "Fastener", "SUDDEN MOVEMENT": "Move suddenly", "SEWING": "Fabric roll", "STORM": "Lightning" }, "AXLE": "Rotating shaft", "SPRING": { "MECHANICAL": "Mechanical coil", "SUDDEN MOVEMENT": "Jump suddenly" }, "DASH": "Rush quickly", "PIN": { "MECHANICAL": "Fastener", "SEWING": "Sewing tool" }, "SURGE": { "SUDDEN MOVEMENT": "Rush forward", "STORM": "Storm surge" }, "SEAM": "Stitched joint", "EYE": { "SEWING": "Hole in a needle", "STORM": "Calm center of a storm" }, "HAIL": "Ice pellets" }
            },
            {
                id: 3, title: "Quarry Query", titleIcon: "ðŸ›ï¸", centerWord: "STONE",
    solutions: [["BIRDIE","MARBLE","GRANITE","SEED","STONE","SLATE","PIT","BROWN","TAUPE"]],
    allWords: ["BIRDIE","MARBLE","GRANITE","SEED","SLATE","PIT","BROWN","TAUPE"],
    quadrantClues: [
        { clue: "SPORTS", words: ["BIRDIE","MARBLE","SEED","STONE"], icon: "ðŸŸï¸" },
        { clue: "MASONRY", words: ["MARBLE","GRANITE","SLATE","STONE"], icon: "ðŸ›ï¸" },
        { clue: "KITCHEN", words: ["SEED","STONE","PIT","BROWN"], icon: "ðŸ³" },
        { clue: "COLORS", words: ["SLATE","STONE","BROWN","TAUPE"], icon: "ðŸŽ¨" }
    ],
    explanations: { 
        "STONE": { 
            "SPORTS": "Game piece used in Curling", 
            "MASONRY": "Natural building material", 
            "KITCHEN": "To remove a pit from fruit", 
            "COLORS": "A neutral, earthy light gray" 
        }, 
        "BIRDIE": "Score of one under par in golf", 
        "MARBLE": { 
            "SPORTS": "Small glass ball used in games", 
            "MASONRY": "Polished metamorphic rock" 
        }, 
        "GRANITE": "Hard igneous rock used for counters", 
        "SEED": { 
            "SPORTS": "Tournament ranking", 
            "KITCHEN": "To remove seeds from fruit" 
        }, 
        "SLATE": { 
            "MASONRY": "Fine-grained rock used for roofing", 
            "COLORS": "A cool, muted blue-gray" 
        }, 
        "PIT": "The hard central seed of a fruit", 
        "BROWN": { 
            "KITCHEN": "To cook food until it darkens", 
            "COLORS": "A dark, warm earth tone" 
        }, 
        "TAUPE": "A dark brownish-gray color" 
    }
            },
            {
                id: 4, title: "Start the Presses", titleIcon: "ðŸ“°", centerWord: "PRESS",
                solutions: [["SCOOP","COPY","SERIF","SPIN","PRESS","PLATE","STARCH","IRON","SQUAT"]],
                allWords: ["SCOOP","COPY","SERIF","SPIN","PLATE","STARCH","IRON","SQUAT"],
                quadrantClues: [{ clue: "MEDIA", words: ["SCOOP","COPY","SPIN","PRESS"], icon: "ðŸ“°" }, { clue: "PRINTING", words: ["COPY","SERIF","PRESS","PLATE"], icon: "ðŸ–¨ï¸" }, { clue: "LAUNDRY", words: ["SPIN","PRESS","STARCH","IRON"], icon: "ðŸ§º" }, { clue: "WEIGHTS", words: ["PRESS","PLATE","IRON","SQUAT"], icon: "ðŸ‹ï¸" }],
                explanations: { "PRESS": { "MEDIA": "News media", "PRINTING": "Printing machine", "LAUNDRY": "Iron clothes", "WEIGHTS": "Lift weights" }, "SCOOP": "An exclusive news story obtained before competitors", "COPY": { "MEDIA": "Written material for publication", "PRINTING": "Text prepared for printing" }, "SERIF": "A small decorative stroke on letters in certain typefaces", "SPIN": { "MEDIA": "Present news with bias", "LAUNDRY": "Washing machine cycle" }, "PLATE": { "PRINTING": "Metal sheet for printing", "WEIGHTS": "Weighted weightlifting disc" }, "STARCH": "A substance used to stiffen fabric during laundering", "IRON": { "LAUNDRY": "Tool for pressing clothes", "WEIGHTS": "Weightlifting equipment" }, "SQUAT": "Strength exercise lowering body by bending knees" }
            },
            {
                id: 5, title: "Punchdrunk", titleIcon: "ðŸ¥Š", centerWord: "PUNCH",
                solutions: [["UPPERCUT","RIPOSTE","SKIT","SMASH","PUNCH","BIT","NEGRONI","SCREWDRIVER","AWL"]],
                allWords: ["UPPERCUT","RIPOSTE","SKIT","SMASH","BIT","NEGRONI","SCREWDRIVER","AWL"],
                quadrantClues: [{ clue: "FIGHTING", words: ["UPPERCUT","RIPOSTE","SMASH","PUNCH"], icon: "ðŸ¤º" }, { clue: "COMEDY", words: ["RIPOSTE","SKIT","PUNCH","BIT"], icon: "ðŸ˜‚" }, { clue: "COCKTAILS", words: ["SMASH","PUNCH","NEGRONI","SCREWDRIVER"], icon: "ðŸ¸" }, { clue: "TOOLS", words: ["PUNCH","BIT","SCREWDRIVER","AWL"], icon: "ðŸ› ï¸" }],
                explanations: { "PUNCH": { "FIGHTING": "Boxing strike", "COMEDY": "Comedy punchline", "COCKTAILS": "Party drink", "TOOLS": "Hole tool" }, "UPPERCUT": "Upward boxing punch", "RIPOSTE": { "FIGHTING": "Quick counter-attack", "COMEDY": "Witty comeback" }, "SKIT": "Short comedy sketch", "SMASH": { "FIGHTING": "Powerful hit", "COCKTAILS": "Cocktail with fruit" }, "BIT": { "COMEDY": "Comedy routine", "TOOLS": "Drill attachment" }, "NEGRONI": "Italian cocktail", "SCREWDRIVER": { "COCKTAILS": "Vodka cocktail", "TOOLS": "Tool for screws" }, "AWL": "Pointed tool for holes" }
            },
            {
                id: 6, title: "Right Turn", titleIcon: "âž¡ï¸", centerWord: "RIGHT",
                solutions: [["DIRECTION","LEFT","WING","STRAIGHT","RIGHT","FRANCHISE","JUST","SOUND","CLAIM"]],
                allWords: ["DIRECTION","LEFT","WING","STRAIGHT","FRANCHISE","JUST","SOUND","CLAIM"],
                quadrantClues: [
                    { clue: "ORIENTATION", words: ["DIRECTION","LEFT","STRAIGHT","RIGHT"], icon: "ðŸ§­" },
                    { clue: "POLITICS", words: ["LEFT","WING","RIGHT","FRANCHISE"], icon: "ðŸ—³ï¸" },
                    { clue: "CORRECTNESS", words: ["STRAIGHT","RIGHT","JUST","SOUND"], icon: "âœ…" },
                    { clue: "BUSINESS", words: ["RIGHT","FRANCHISE","SOUND","CLAIM"], icon: "ðŸ’¼" }
                ],
                explanations: {
                    "RIGHT": { "ORIENTATION": "Direction", "POLITICS": "Conservative political wing", "BUSINESS": "Entitlement", "CORRECTNESS": "Correct" },
                    "DIRECTION": "Orientation or course",
                    "LEFT": { "ORIENTATION": "Direction opposite of right", "POLITICS": "Progressive political grouping" },
                    "WING": "Political faction",
                    "FRANCHISE": { "POLITICS": "Voting rights", "BUSINESS": "Licensed chain model" },
                    "CLAIM": "Demand or assertion of a right to something",
                    "SOUND": { "BUSINESS": "Financially solid", "CORRECTNESS": "Logically valid" },
                    "JUST": "Morally right, fair, or proper",
                    "STRAIGHT": { "ORIENTATION": "Directly ahead", "CORRECTNESS": "Honest and direct" }
                }
            },
            {
                id: 7, title: "In Any Case", titleIcon: "ðŸ“", centerWord: "CASE",
                solutions: [["LAWSUIT","CAPITAL","FONT","SENTENCE","CASE","STROKE","PRONOUN","COMPOUND","PATIENT"]],
                allWords: ["LAWSUIT","CAPITAL","FONT","SENTENCE","STROKE","PRONOUN","COMPOUND","PATIENT"],
                quadrantClues: [
                    { clue: "LAW", words: ["LAWSUIT","CAPITAL","SENTENCE","CASE"], icon: "âš–ï¸" },
                    { clue: "TYPE", words: ["CAPITAL","FONT","CASE","STROKE"], icon: "ðŸ”¤" },
                    { clue: "GRAMMAR", words: ["SENTENCE","CASE","PRONOUN","COMPOUND"], icon: "âœï¸" },
                    { clue: "MEDICAL", words: ["CASE","STROKE","COMPOUND","PATIENT"], icon: "ðŸ©º" }
                ],
                explanations: {
                    "CASE": { "LAW": "Legal proceeding", "TYPE": "Upper or lower", "GRAMMAR": "Noun inflection", "MEDICAL": "Patient file" },
                    "LAWSUIT": "Legal action filed in court",
                    "CAPITAL": { "LAW": "Punishable by death", "TYPE": "Uppercase letter" },
                    "FONT": "Typeface design",
                    "SENTENCE": { "LAW": "Court punishment", "GRAMMAR": "Grammatical unit" },
                    "STROKE": { "TYPE": "Pen mark forming letter", "MEDICAL": "Cerebrovascular event" },
                    "PRONOUN": "Word replacing a noun",
                    "COMPOUND": { "GRAMMAR": "Joined clause structure", "MEDICAL": "Multi-bone fracture" },
                    "PATIENT": "Person receiving medical care"
                }
            },
            {
                id: 8, title: "Raise the Stakes", titleIcon: "ðŸŽ¯", centerWord: "PITCH",
                solutions: [["INVESTORS","ANGELS","YANKS","STAKE","PITCH","HITS","CAMPING","COVER","ALBUM"]],
                allWords: ["INVESTORS","ANGELS","YANKS","STAKE","HITS","CAMPING","COVER","ALBUM"],
                quadrantClues: [{ clue: "VENTURE", words: ["INVESTORS","ANGELS","STAKE","PITCH"], icon: "ðŸ’¼" }, { clue: "BASEBALL", words: ["ANGELS","YANKS","PITCH","HITS"], icon: "âš¾" }, { clue: "TENTS", words: ["STAKE","PITCH","CAMPING","COVER"], icon: "â›º" }, { clue: "MUSIC", words: ["PITCH","HITS","COVER","ALBUM"], icon: "ðŸŽµ" }],
                explanations: { "PITCH": { "VENTURE": "Business presentation", "BASEBALL": "Thrown ball", "TENTS": "Tent setup", "MUSIC": "Musical tone" }, "INVESTORS": "People who fund ventures", "ANGELS": { "VENTURE": "Angel investors", "BASEBALL": "LA baseball team" }, "YANKS": "New York Yankees baseball team", "STAKE": { "VENTURE": "Equity share", "TENTS": "Tent peg" }, "HITS": { "BASEBALL": "Successful at-bats", "MUSIC": "Popular songs" }, "CAMPING": "Outdoor activity with tents", "COVER": { "TENTS": "Tent protection", "MUSIC": "Song remake" }, "ALBUM": "Collection of songs" }
            },
            {
                id: 9, title: "On a Roll", titleIcon: "ðŸŽ²", centerWord: "ROLL",
                solutions: [["TUMBLE","SHAKE","BUN","RHYTHM","ROLL","STOCK","SONG","SCORE","CAMERA"]],
                allWords: ["TUMBLE","SHAKE","BUN","RHYTHM","STOCK","SONG","SCORE","CAMERA"],
                quadrantClues: [{ clue: "MOVEMENT", words: ["TUMBLE","SHAKE","RHYTHM","ROLL"], icon: "ðŸƒ" }, { clue: "FOOD", words: ["SHAKE","BUN","ROLL","STOCK"], icon: "ðŸ”" }, { clue: "MUSIC", words: ["RHYTHM","ROLL","SONG","SCORE"], icon: "ðŸŽµ" }, { clue: "FILM", words: ["ROLL","STOCK","SCORE","CAMERA"], icon: "ðŸŽ¬" }],
                explanations: { "ROLL": { "MOVEMENT": "Tumble", "FOOD": "Bread", "MUSIC": "Rock music", "FILM": "Film" }, "TUMBLE": "To fall or roll over", "SHAKE": { "MOVEMENT": "Move quickly", "FOOD": "Milkshake" }, "BUN": "A small bread roll", "RHYTHM": { "MOVEMENT": "Movement pattern", "MUSIC": "Musical beat" }, "STOCK": { "FOOD": "Food broth", "FILM": "Photographic film" }, "SONG": "Musical piece with words", "SCORE": { "MUSIC": "Written music", "FILM": "Film soundtrack" }, "CAMERA": "Device for capturing film" }
            },
            {
                id: 10, title: "Big Draws", titleIcon: "ðŸŽŸï¸", centerWord: "DRAW",
                solutions: [["HEADLINER","PLAY","TIE","CLIP","DRAW","POOL","GUN","PUMP","WELL"]],
                allWords: ["HEADLINER","PLAY","TIE","CLIP","POOL","GUN","PUMP","WELL"],
                quadrantClues: [{ clue: "ENTERTAINMENT", words: ["HEADLINER","PLAY","CLIP","DRAW"], icon: "ðŸŽ­" }, { clue: "SPORTS", words: ["PLAY","TIE","DRAW","POOL"], icon: "ðŸŸï¸" }, { clue: "WEAPONS", words: ["CLIP","DRAW","GUN","PUMP"], icon: "ðŸ”«" }, { clue: "WATER", words: ["DRAW","POOL","PUMP","WELL"], icon: "ðŸ’§" }],
                explanations: { "DRAW": { "ENTERTAINMENT": "Attraction", "SPORTS": "Tied game", "WEAPONS": "Pull weapon", "WATER": "Extract water" }, "HEADLINER": "Main performer or act", "PLAY": { "ENTERTAINMENT": "Theatrical production", "SPORTS": "Game action" }, "TIE": "Even score in sports", "CLIP": { "ENTERTAINMENT": "Video segment", "WEAPONS": "Ammo holder" }, "POOL": { "SPORTS": "Billiards game", "WATER": "Body of water" }, "GUN": "Firearm weapon", "PUMP": { "WEAPONS": "Pump-action shotgun", "WATER": "Water device" }, "WELL": "Water shaft or hole" }
            },
            {
                id: 11, title: "That Rocks", titleIcon: "ðŸŽ¸", centerWord: "ROCK",
                solutions: [["JAZZ","BEAT","JOLT","BAND","ROCK","HAMMER","GEM","STONE","MARBLE"]],
                allWords: ["JAZZ","BEAT","JOLT","BAND","HAMMER","GEM","STONE","MARBLE"],
                quadrantClues: [{ clue: "MUSIC", words: ["JAZZ","BEAT","BAND","ROCK"], icon: "ðŸŽµ" }, { clue: "DESTABILIZE", words: ["BEAT","JOLT","ROCK","HAMMER"], icon: "ðŸ’¥" }, { clue: "JEWELRY", words: ["BAND","ROCK","GEM","STONE"], icon: "ðŸ’" }, { clue: "SCULPTURE", words: ["ROCK","HAMMER","STONE","MARBLE"], icon: "ðŸ—¿" }],
                explanations: { "ROCK": { "MUSIC": "Music genre", "DESTABILIZE": "Hit hard, stun", "JEWELRY": "Precious stone", "SCULPTURE": "Sculpting material" }, "JAZZ": "Improvisational music genre", "BEAT": { "MUSIC": "Rhythm", "DESTABILIZE": "Defeat soundly" }, "JOLT": "Sudden shock or impact", "BAND": { "MUSIC": "Musical group", "JEWELRY": "Ring" }, "HAMMER": { "DESTABILIZE": "Criticize harshly", "SCULPTURE": "Sculptor's tool" }, "GEM": "Precious stone", "STONE": { "JEWELRY": "Precious gem", "SCULPTURE": "Carving material" }, "MARBLE": "Fine-grained sculpting stone" }
            },
            {
                id: 12, title: "Room and Board", titleIcon: "ðŸ›ï¸", centerWord: "BOARD",
                solutions: [["PLANK","DECK","SHIP","PANEL","BOARD","COURSE","MOTION","TABLE","MEAL"]],
                allWords: ["PLANK","DECK","SHIP","PANEL","COURSE","MOTION","TABLE","MEAL"],
                quadrantClues: [{ clue: "LUMBER", words: ["PLANK","DECK","PANEL","BOARD"], icon: "ðŸªµ" }, { clue: "NAUTICAL", words: ["DECK","SHIP","BOARD","COURSE"], icon: "â›µ" }, { clue: "GOVERNANCE", words: ["PANEL","BOARD","MOTION","TABLE"], icon: "âš–ï¸" }, { clue: "DINING", words: ["BOARD","COURSE","TABLE","MEAL"], icon: "ðŸ½ï¸" }],
                explanations: { "BOARD": { "LUMBER": "Wood plank", "NAUTICAL": "Ship boarding", "GOVERNANCE": "Governing body", "DINING": "Meals provided" }, "PLANK": "Heavy thick board used in construction", "DECK": { "LUMBER": "Wooden platform", "NAUTICAL": "Floor of a ship" }, "SHIP": "Large vessel that travels by sea", "PANEL": { "LUMBER": "Wood sheet", "GOVERNANCE": "Group of experts" }, "COURSE": { "NAUTICAL": "Ship's route", "DINING": "Part of a meal" }, "MOTION": "Formal proposal in governance proceedings", "TABLE": { "GOVERNANCE": "To postpone consideration", "DINING": "Dining furniture" }, "MEAL": "Occasion of eating food" }
            },
            {
                id: 13, title: "Tipping the Scales", titleIcon: "âš–ï¸", centerWord: "SCALE",
                solutions: [["TEMPO","BASS","SOLE","KEY","SCALE","NET","GRID","UNITS","BALANCE"]],
                allWords: ["TEMPO","BASS","SOLE","KEY","NET","GRID","UNITS","BALANCE"],
                quadrantClues: [{ clue: "MUSIC", words: ["TEMPO","BASS","KEY","SCALE"], icon: "ðŸŽµ" }, { clue: "FISH", words: ["BASS","SOLE","SCALE","NET"], icon: "ðŸŸ" }, { clue: "MAPS", words: ["KEY","SCALE","GRID","UNITS"], icon: "ðŸ—ºï¸" }, { clue: "WEIGHING", words: ["SCALE","NET","UNITS","BALANCE"], icon: "âš–ï¸" }],
                explanations: { "SCALE": { "MUSIC": "Musical notes sequence", "FISH": "Fish skin", "MAPS": "Map ratio", "WEIGHING": "Weighing device" }, "TEMPO": "Speed or pace of music", "BASS": { "MUSIC": "Low musical pitch", "FISH": "Type of fish" }, "SOLE": "Flat fish species", "KEY": { "MUSIC": "Musical tonal center", "MAPS": "Map legend" }, "NET": { "FISH": "Fishing tool", "WEIGHING": "Weight after deductions" }, "GRID": "Lines forming map coordinates", "UNITS": { "MAPS": "Map measurement", "WEIGHING": "Weight measurement" }, "BALANCE": "Device for comparing masses" }
            },
            {
                id: 14, title: "Fair and Square", titleIcon: "ðŸŸ¦", centerWord: "SQUARE",
                solutions: [["OVAL","BLOCK","PARK","CUBE","SQUARE","BENCH","PRIME","EVEN","JUST"]],
                allWords: ["OVAL","BLOCK","PARK","CUBE","BENCH","PRIME","EVEN","JUST"],
                quadrantClues: [{ clue: "SHAPES", words: ["OVAL","BLOCK","CUBE","SQUARE"], icon: "ðŸ”·" }, { clue: "CITY", words: ["BLOCK","PARK","SQUARE","BENCH"], icon: "ðŸ™ï¸" }, { clue: "MATH", words: ["CUBE","SQUARE","PRIME","EVEN"], icon: "âž—" }, { clue: "FAIRNESS", words: ["SQUARE","BENCH","EVEN","JUST"], icon: "âš–ï¸" }],
                explanations: { "SQUARE": { "SHAPES": "Shape", "CITY": "City plaza", "MATH": "Multiply by itself", "FAIRNESS": "Fair and honest" }, "OVAL": "Elongated circular or egg-like shape", "BLOCK": { "SHAPES": "Solid cube shape", "CITY": "City section between streets" }, "PARK": "Public green space in a city", "CUBE": { "SHAPES": "Six-sided 3D shape", "MATH": "Third power in math" }, "BENCH": { "CITY": "Public seat in a park", "FAIRNESS": "The judge's seat or office" }, "PRIME": "Number divisible only by 1 and itself", "EVEN": { "MATH": "Divisible by two", "FAIRNESS": "Fair or equal" }, "JUST": "Fair, righteous, or morally correct" }
            },
            {
                id: 15, title: "Crowned Heads", titleIcon: "ðŸ‘‘", centerWord: "KING",
                solutions: [["JUMP","BOARD","MATE","CROWN","KING","RANK","REIGN","COURT","SUIT"]],
                allWords: ["JUMP","BOARD","MATE","CROWN","RANK","REIGN","COURT","SUIT"],
                quadrantClues: [{ clue: "CHECKERS", words: ["JUMP","BOARD","CROWN","KING"], icon: "âš«" }, { clue: "CHESS", words: ["BOARD","MATE","KING","RANK"], icon: "â™Ÿï¸" }, { clue: "MONARCHY", words: ["CROWN","KING","REIGN","COURT"], icon: "ðŸ‘‘" }, { clue: "CARDS", words: ["KING","RANK","COURT","SUIT"], icon: "ðŸƒ" }],
                explanations: { "KING": { "CHECKERS": "Checkers piece", "CHESS": "Chess piece", "MONARCHY": "Monarch", "CARDS": "Face card" }, "JUMP": "To capture an opponent's piece in checkers", "BOARD": { "CHECKERS": "Playing surface for checkers", "CHESS": "Playing surface for chess" }, "MATE": "Winning position in chess ('Checkmate')", "CROWN": { "CHECKERS": "To promote a checker", "MONARCHY": "Royal headgear" }, "RANK": { "CHESS": "Horizontal row on a chessboard", "CARDS": "Card value" }, "REIGN": "Period of a monarch's rule", "COURT": { "MONARCHY": "Royal entourage", "CARDS": "Face cards (J, Q, K)" }, "SUIT": "Card category (Hearts, Clubs, etc.)" }
            },
            {
                id: 16, title: "Break a Leg", titleIcon: "ðŸ¤•", centerWord: "CAST",
                solutions: [["CURTAIN","STAGE","SUTURE","LINE","CAST","BRACE","REEL","HOOK","ANVIL"]],
                allWords: ["CURTAIN","STAGE","SUTURE","LINE","BRACE","REEL","HOOK","ANVIL"],
                quadrantClues: [{ clue: "THEATER", words: ["CURTAIN","STAGE","LINE","CAST"], icon: "ðŸŽ­" }, { clue: "MEDICINE", words: ["STAGE","SUTURE","CAST","BRACE"], icon: "ðŸ¥" }, { clue: "FISHING", words: ["LINE","CAST","REEL","HOOK"], icon: "ðŸŽ£" }, { clue: "METALWORK", words: ["CAST","BRACE","HOOK","ANVIL"], icon: "âš’ï¸" }],
                explanations: { "CAST": { "THEATER": "Actors", "MEDICINE": "Plaster casing", "FISHING": "Throw line", "METALWORK": "Mold metal" }, "CURTAIN": "Theater drape or barrier", "STAGE": { "THEATER": "Performance platform", "MEDICINE": "Degree of illness progression" }, "SUTURE": "Medical stitch", "LINE": { "THEATER": "Spoken dialogue", "FISHING": "Fishing string" }, "BRACE": { "MEDICINE": "Orthopedic support", "METALWORK": "Structural metal support" }, "REEL": "Winding device for fishing", "HOOK": { "FISHING": "Fishing barb", "METALWORK": "Curved metal tool" }, "ANVIL": "Heavy block for shaping metal" }
            },
            {
                id: 17, title: "Liquid Logic", titleIcon: "ðŸ§ª", centerWord: "SOLUTION",
                solutions: [["ROOT","BASE","ACID","SQUARE","SOLUTION","AGENT","DOWN","CLUE","CRIME"]],
                allWords: ["ROOT","BASE","ACID","SQUARE","AGENT","DOWN","CLUE","CRIME"],
                quadrantClues: [{ clue: "MATH", words: ["ROOT","BASE","SQUARE","SOLUTION"], icon: "âž—" }, { clue: "CHEMISTRY", words: ["BASE","ACID","AGENT","SOLUTION"], icon: "ðŸ§ª" }, { clue: "CROSSWORDS", words: ["SQUARE","SOLUTION","CLUE","DOWN"], icon: "âœï¸" }, { clue: "MYSTERY", words: ["SOLUTION","AGENT","CLUE","CRIME"], icon: "ðŸ•µï¸" }],
                explanations: { "SOLUTION": { "MATH": "Math answer", "CHEMISTRY": "Chemical mixture", "CROSSWORDS": "Puzzle answer", "MYSTERY": "Solved crime" }, "ROOT": "Origin of a number (Square Root)", "BASE": { "MATH": "Number system radix", "CHEMISTRY": "Chemical with pH > 7" }, "ACID": "Chemical substance with pH < 7", "SQUARE": { "MATH": "Number times itself", "CROSSWORDS": "Box in a crossword grid" }, "AGENT": { "CHEMISTRY": "Chemical substance", "MYSTERY": "Investigator or spy" }, "DOWN": "Crossword answer direction", "CLUE": { "CROSSWORDS": "Hint for a puzzle", "MYSTERY": "Evidence in a crime" }, "CRIME": "Unlawful act to be investigated" }
            },
            {
                id: 18, title: "Court Order", titleIcon: "âš–ï¸", centerWord: "COURT",
                solutions: [["THRONE","BALL","SQUASH","PEERS","COURT","MATCH","GAVEL","BOND","FLAME"]],
                allWords: ["THRONE","BALL","SQUASH","PEERS","MATCH","GAVEL","BOND","FLAME"],
                quadrantClues: [{ clue: "ROYALTY", words: ["THRONE","BALL","PEERS","COURT"], icon: "ðŸ‘‘" }, { clue: "SPORTS", words: ["BALL","SQUASH","MATCH","COURT"], icon: "ðŸ¸" }, { clue: "LAW", words: ["PEERS","COURT","GAVEL","BOND"], icon: "âš–ï¸" }, { clue: "ROMANCE", words: ["COURT","MATCH","BOND","FLAME"], icon: "ðŸ’•" }],
                explanations: { "COURT": { "ROYALTY": "Royal court", "SPORTS": "Playing court", "LAW": "Court of law", "ROMANCE": "To woo" }, "THRONE": "Monarch's seat", "BALL": { "ROYALTY": "Formal dance", "SPORTS": "Sports equipment" }, "SQUASH": "Racket sport", "PEERS": { "ROYALTY": "Nobles", "LAW": "Jury of one's peers" }, "MATCH": { "SPORTS": "Competition", "ROMANCE": "Marriage partner" }, "GAVEL": "Judge's mallet", "BOND": { "LAW": "Bail security", "ROMANCE": "Emotional connection" }, "FLAME": "Sweetheart" }
            },
            {
                id: 19, title: "The Gambit", titleIcon: "ðŸŽ²", centerWord: "PIECE",
                solutions: [["KNIGHT","MINIATURE","STATUE","CHECKER","PIECE","LOT","SCOOP","STOCK","SHARE"]],
                allWords: ["KNIGHT","MINIATURE","STATUE","CHECKER","LOT","SCOOP","STOCK","SHARE"],
                quadrantClues: [{ clue: "GAMES", words: ["KNIGHT","MINIATURE","CHECKER","PIECE"], icon: "ðŸŽ²" }, { clue: "ART", words: ["MINIATURE","STATUE","PIECE","LOT"], icon: "ðŸŽ¨" }, { clue: "NEWS", words: ["CHECKER","PIECE","SCOOP","STOCK"], icon: "ðŸ“°" }, { clue: "FINANCE", words: ["PIECE","LOT","STOCK","SHARE"], icon: "ðŸ“ˆ" }],
                explanations: { "PIECE": { "GAMES": "Game token", "ART": "Artwork", "NEWS": "Article", "FINANCE": "Share of business" }, "KNIGHT": "Chess piece", "MINIATURE": { "GAMES": "Small game model", "ART": "Miniature painting" }, "STATUE": "Sculptural artwork", "CHECKER": { "GAMES": "Game piece", "NEWS": "Fact-checker" }, "LOT": { "ART": "Auction item", "FINANCE": "Bundle of shares" }, "SCOOP": "Exclusive news story", "STOCK": { "NEWS": "Stock photo", "FINANCE": "Company share" }, "SHARE": "Unit of ownership" }
            },
            {
                id: 20, title: "Root Cause", titleIcon: "ðŸŒ³", centerWord: "ROOT",
                solutions: [["LEAF","PLOT","LOG","FIELD","ROOT","BASE","PLAY","HOME","SOURCE"]],
                allWords: ["LEAF","PLOT","LOG","FIELD","BASE","PLAY","HOME","SOURCE"],
                quadrantClues: [{ clue: "VEGETATION", words: ["LEAF","PLOT","FIELD","ROOT"], icon: "ðŸŒ¿" }, { clue: "MATH", words: ["PLOT","LOG","BASE","ROOT"], icon: "ðŸ§®" }, { clue: "SPORTS", words: ["FIELD","PLAY","HOME","ROOT"], icon: "ðŸŸï¸" }, { clue: "ORIGIN", words: ["BASE","SOURCE","HOME","ROOT"], icon: "ðŸ“" }],
                explanations: { "ROOT": { "VEGETATION": "Underground part", "MATH": "Square root", "SPORTS": "Cheer for a team", "ORIGIN": "Ancestry" }, "LEAF": "Foliage", "PLOT": { "VEGETATION": "Garden plot", "MATH": "Plot points on a graph" }, "LOG": "Logarithm", "FIELD": { "VEGETATION": "Meadow", "SPORTS": "Playing surface" }, "BASE": { "MATH": "Exponent base", "ORIGIN": "Foundation" }, "PLAY": "Game action", "HOME": { "SPORTS": "Team's own venue", "ORIGIN": "Homeland" }, "SOURCE": "Beginning point" }
            },
            {
                id: 21, title: "Full Tank", titleIcon: "â›½", centerWord: "TANK",
                solutions: [["GAS","RESERVE","ARMOR","VOLUME","TANK","MARINE","SLUMP","BUBBLES","CORAL"]],
                allWords: ["GAS","RESERVE","ARMOR","VOLUME","MARINE","SLUMP","BUBBLES","CORAL"],
                quadrantClues: [{ clue: "FUEL", words: ["GAS","RESERVE","VOLUME","TANK"], icon: "â›½" }, { clue: "MILITARY", words: ["RESERVE","ARMOR","MARINE","TANK"], icon: "ðŸŽ–ï¸" }, { clue: "MARKET", words: ["VOLUME","SLUMP","BUBBLES","TANK"], icon: "ðŸ“‰" }, { clue: "AQUARIUM", words: ["MARINE","CORAL","BUBBLES","TANK"], icon: "ðŸ " }],
                explanations: { "TANK": { "FUEL": "Fuel container", "MILITARY": "Armored vehicle", "MARKET": "To crash", "AQUARIUM": "Fish tank" }, "GAS": "Fuel type", "RESERVE": { "FUEL": "Backup supply", "MILITARY": "Military forces held back" }, "ARMOR": "Protective military covering", "VOLUME": { "FUEL": "Capacity of a container", "MARKET": "Quantity traded" }, "MARINE": { "MILITARY": "Military branch", "AQUARIUM": "Saltwater tank" }, "SLUMP": "Stock market downturn", "BUBBLES": { "MARKET": "Economic bubbles", "AQUARIUM": "Air in water" }, "CORAL": "Marine organism" }
            },
            {
                id: 22, title: "Subject Matter", titleIcon: "ðŸ“–", centerWord: "SUBJECT",
                solutions: [["SYNTAX","PERIOD","ELECTIVE","RULE","SUBJECT","STUDY","THRONE","GRANT","HYPOTHESIS"]],
                allWords: ["SYNTAX","PERIOD","ELECTIVE","RULE","STUDY","THRONE","GRANT","HYPOTHESIS"],
                quadrantClues: [{ clue: "GRAMMAR", words: ["SYNTAX","PERIOD","RULE","SUBJECT"], icon: "âœï¸" }, { clue: "ACADEMICS", words: ["PERIOD","ELECTIVE","SUBJECT","STUDY"], icon: "ðŸ“š" }, { clue: "ROYALTY", words: ["RULE","SUBJECT","THRONE","GRANT"], icon: "ðŸ‘‘" }, { clue: "SCIENCE", words: ["SUBJECT","STUDY","GRANT","HYPOTHESIS"], icon: "ðŸ”¬" }],
                explanations: { "SUBJECT": { "GRAMMAR": "Doer of the action", "ACADEMICS": "Course of study", "ROYALTY": "One under a sovereign", "SCIENCE": "Experiment participant" }, "PERIOD": { "GRAMMAR": "Punctuation mark", "ACADEMICS": "Class time slot" }, "RULE": { "GRAMMAR": "Linguistic guideline", "ROYALTY": "Sovereign reign" }, "STUDY": { "ACADEMICS": "Review material", "SCIENCE": "Research investigation" }, "GRANT": { "ROYALTY": "Bestowed land or charter", "SCIENCE": "Research funding" }, "SYNTAX": "Sentence structure rules", "ELECTIVE": "Optional course", "THRONE": "Monarch's seat", "HYPOTHESIS": "Testable prediction" }
            },
            {
                id: 23, title: "Light Workload", titleIcon: "âœ¨", centerWord: "LIGHT",
                solutions: [["LENS","FLASH","EMBER","TONE","LIGHT","BURNOUT","FUNNY","HEAVY","BURDENSOME"]],
                allWords: ["LENS","FLASH","EMBER","TONE","BURNOUT","FUNNY","HEAVY","BURDENSOME"],
                quadrantClues: [{ clue: "PHOTO", words: ["LENS","FLASH","TONE","LIGHT"], icon: "ðŸ“·" }, { clue: "IGNITION", words: ["FLASH","EMBER","BURNOUT","LIGHT"], icon: "ðŸ”¥" }, { clue: "EXPRESSION", words: ["TONE","FUNNY","HEAVY","LIGHT"], icon: "ðŸ’¬" }, { clue: "WORKLOAD", words: ["BURDENSOME","BURNOUT","HEAVY","LIGHT"], icon: "ðŸ“Š" }],
                explanations: { "LIGHT": { "PHOTO": "Illumination", "IGNITION": "To ignite", "EXPRESSION": "Not serious in tone", "WORKLOAD": "Not burdensome" }, "LENS": "Camera element", "FLASH": { "PHOTO": "Camera flash", "IGNITION": "Cause to burst into flame" }, "EMBER": "Glowing piece of coal or wood", "TONE": { "PHOTO": "Degree of lightness or darkness", "EXPRESSION": "Attitude conveyed in speech" }, "BURNOUT": { "IGNITION": "Flame exhaustion", "WORKLOAD": "Work exhaustion" }, "FUNNY": "Causing laughter or amusement", "HEAVY": { "EXPRESSION": "Serious or emotionally intense", "WORKLOAD": "Demanding in effort" }, "BURDENSOME": "Arduous and demanding" }
            },
            {
                id: 24, title: "Slash and Burn", titleIcon: "ðŸŽ¸", centerWord: "SLASH",
                solutions: [["STAB","CUT","EXCISE","STING","SLASH","DASH","BONO","SEAL","ASTERISK"]],
                allWords: ["STAB","CUT","EXCISE","STING","DASH","BONO","SEAL","ASTERISK"],
                quadrantClues: [{ clue: "VIOLENCE", words: ["STAB","CUT","STING","SLASH"], icon: "ðŸ”ª" }, { clue: "ELIMINATION", words: ["CUT","EXCISE","SLASH","DASH"], icon: "âœ‚ï¸" }, { clue: "ROCKERS", words: ["STING","SLASH","BONO","SEAL"], icon: "ðŸŽ¸" }, { clue: "SYMBOLS", words: ["SLASH","DASH","SEAL","ASTERISK"], icon: "âœ±" }],
                explanations: { "SLASH": { "VIOLENCE": "Knife attack", "ELIMINATION": "Cut drastically", "ROCKERS": "Guns N' Roses guitarist", "SYMBOLS": "Forward slash /" }, "STAB": "Piercing attack", "CUT": { "VIOLENCE": "Knife wound", "ELIMINATION": "Remove or reduce" }, "EXCISE": "Surgically remove", "STING": { "VIOLENCE": "Sharp painful wound", "ROCKERS": "The Police frontman" }, "DASH": { "ELIMINATION": "Strike out text", "SYMBOLS": "Hyphen or em dash" }, "BONO": "U2 frontman", "SEAL": { "ROCKERS": "'Kiss from a Rose' singer", "SYMBOLS": "Official emblem" }, "ASTERISK": "Star-shaped symbol *" }
            },
            {
                id: 25, title: "Rank & File", titleIcon: "ðŸ—„ï¸", centerWord: "FILE",
                solutions: [["STAPLER","FOLDER","BYTE","STAMP","FILE","COMMAND","VISE","DRILL","PLATOON"]],
                allWords: ["STAPLER","FOLDER","BYTE","STAMP","COMMAND","VISE","DRILL","PLATOON"],
                quadrantClues: [{ clue: "PAPERWORK", words: ["STAPLER","FOLDER","STAMP","FILE"], icon: "ðŸ“Ž" }, { clue: "OS", words: ["FOLDER","BYTE","FILE","COMMAND"], icon: "ðŸ’»" }, { clue: "SHOP", words: ["STAMP","FILE","VISE","DRILL"], icon: "ðŸ§°" }, { clue: "ARMY", words: ["FILE","COMMAND","DRILL","PLATOON"], icon: "ðŸª–" }],
                explanations: { "FILE": { "PAPERWORK": "Collection of documents", "OS": "Stored digital document", "SHOP": "Tool for smoothing metal", "ARMY": "A line formation: single file" }, "STAPLER": "Joins sheets of paper", "FOLDER": { "PAPERWORK": "Holds paper documents", "OS": "Directory for files" }, "BYTE": "Unit of digital data", "STAMP": { "PAPERWORK": "Ink device for official marks", "SHOP": "Steel punch for marking metal" }, "COMMAND": { "OS": "Instruction at a command line", "ARMY": "Authority to give orders" }, "VISE": "Clamp that holds work steady", "DRILL": { "SHOP": "Boring tool for making holes", "ARMY": "Training exercise and discipline practice" }, "PLATOON": "Small Army unit" }
            }
        ];

        function App() {
            const [puzzleIdx, setPuzzleIdx] = useState(0);
            const [grid, setGrid] = useState([]);
            const [selected, setSelected] = useState(null);
            const [history, setHistory] = useState([]);
            const [historyIdx, setHistoryIdx] = useState(-1);
            const [solved, setSolved] = useState(false);
            const [showThemes, setShowThemes] = useState(true);
            const [showHelp, setShowHelp] = useState(false);
            const [moves, setMoves] = useState(0);
            const [solutionIndex, setSolutionIndex] = useState(0);
            const [userSolutionIndex, setUserSolutionIndex] = useState(null);
            const [difficulty] = useState('medium'); 
            const [timer, setTimer] = useState(0); 
            const [timerActive, setTimerActive] = useState(false);
            const [showGallery, setShowGallery] = useState(false);
            const [solvedPuzzles, setSolvedPuzzles] = useState(() => {
                const saved = localStorage.getItem('connectionary_solved_puzzles');
                return saved ? JSON.parse(saved) : {};
            });
            
            const [showWelcome, setShowWelcome] = useState(() => {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('welcome') === 'true') return true;
                const dontShowAgain = localStorage.getItem('connectionary_v2_hide_welcome') === 'true';
                return !dontShowAgain;
            });
            const [dontShowWelcome, setDontShowWelcome] = useState(false);
            
            useEffect(() => {
                if (localStorage.getItem('connectionary_v2_hide_welcome') !== 'true') {
                    setShowHelp(true);
                }
            }, []);

            const [solvedQuadrantOrder, setSolvedQuadrantOrder] = useState([]);

            const puzzle = PUZZLES[puzzleIdx];

            const deterministicShuffle = () => {
                const solution = puzzle.solutions[0];
                const cornerPositions = [0, 2, 6, 8];
                const edgePositions = [1, 3, 5, 7];
                const cornerWords = cornerPositions.map(p => solution[p]);
                const edgeWords = edgePositions.map(p => solution[p]);
                
                const shuffled = new Array(9);
                shuffled[4] = puzzle.centerWord;
                
                const shuffledCorners = [...cornerWords].sort(() => Math.random() - 0.5);
                const shuffledEdges = [...edgeWords].sort(() => Math.random() - 0.5);
                
                edgePositions.forEach((pos, i) => { shuffled[pos] = shuffledCorners[i]; });
                cornerPositions.forEach((pos, i) => { shuffled[pos] = shuffledEdges[i]; });
                
                return shuffled;
            };

            useEffect(() => {
                const shuffled = deterministicShuffle();
                setGrid(shuffled);
                setHistory([shuffled]);
                setHistoryIdx(0);
                setSolved(false);
                setSelected(null);
                setMoves(0);
                setShowThemes(true);
                setSolutionIndex(0);
                setUserSolutionIndex(null);
                setSolvedQuadrantOrder([]);
                setTimer(0);
                setTimerActive(true);
            }, [puzzleIdx, difficulty]);

            useEffect(() => {
                let interval;
                if (timerActive && !solved) {
                    interval = setInterval(() => {
                        setTimer(prev => prev + 1);
                    }, 1000);
                }
                return () => {
                    if (interval) clearInterval(interval);
                };
            }, [timerActive, solved]);

            useEffect(() => {
                if (grid.length === 0) return;
                const solIndex = FIXED_QUADRANTS
                    ? (JSON.stringify(puzzle.solutions[0]) === JSON.stringify(grid) ? 0 : -1)
                    : puzzle.solutions.findIndex(sol => JSON.stringify(sol) === JSON.stringify(grid));
                
                if (solIndex !== -1 && !solved) {
                    setSolved(true);
                    setUserSolutionIndex(solIndex);
                    setSolutionIndex(solIndex);
                    setShowThemes(true);
                    setTimerActive(false);
                    const newSolvedPuzzles = { ...solvedPuzzles, [puzzle.id]: true };
                    setSolvedPuzzles(newSolvedPuzzles);
                    localStorage.setItem('connectionary_solved_puzzles', JSON.stringify(newSolvedPuzzles));
                }
            }, [grid]);

            const getFontSize = (word) => {
                if (word.length <= 5) return 'text-lg';
                if (word.length <= 8) return 'text-base';
                if (word.length <= 10) return 'text-sm';
                return 'text-xs';
            };

            const getDisplayWord = (word) => {
                const explanation = puzzle.explanations[word];
                if (!explanation) return word;
                if (typeof explanation === 'object') {
                    const hasPhrase = Object.values(explanation).some(def => 
                        typeof def === 'string' && def.startsWith('*')
                    );
                    return hasPhrase ? word + '*' : word;
                }
                if (typeof explanation === 'string' && explanation.startsWith('*')) {
                    return word + '*';
                }
                return word;
            };

            const checkPartialQuadrants = () => {
                if (difficulty === 'hard') return null;
                if (FIXED_QUADRANTS) {
                    const sol = puzzle.solutions[0];
                    const exact = (positions) => positions.every(p => grid[p] === sol[p]);
                    return {
                        tl: exact([0, 1, 3, 4]) ? puzzle.quadrantClues[0].icon : null,
                        tr: exact([1, 2, 4, 5]) ? puzzle.quadrantClues[1].icon : null,
                        bl: exact([3, 4, 6, 7]) ? puzzle.quadrantClues[2].icon : null,
                        br: exact([4, 5, 7, 8]) ? puzzle.quadrantClues[3].icon : null
                    };
                }
                return null;
            };

            const getVisibleDefinitions = (word) => {
                const explanation = puzzle.explanations[word];
                if (!explanation) return null;
                
                if (typeof explanation === 'string') {
                    const wordTheme = puzzle.quadrantClues.find(q => q.words.includes(word));
                    if (wordTheme && solvedQuadrantOrder.includes(wordTheme.clue)) {
                        return explanation;
                    }
                    return null;
                }
                
                const definitions = [];
                for (const themeName of solvedQuadrantOrder) {
                    if (explanation[themeName]) {
                        definitions.push(explanation[themeName]);
                    }
                }
                
                return definitions.length > 0 ? definitions.join(' / ') : null;
            };
            
            const getFullDefinition = (word) => {
                const explanation = puzzle.explanations[word];
                if (!explanation) return null;
                if (typeof explanation === 'string') return explanation;
                return Object.values(explanation).join(' / ');
            };

            const getQuadrantCluesBySpatialPosition = (currentGrid) => {
                if (FIXED_QUADRANTS) {
                    return puzzle.quadrantClues.map((t, idx) => ({ ...t, quadrantIndex: idx }));
                }
                return puzzle.quadrantClues; 
            };

            const handleCellClick = (idx) => {
                if (solved) return;
                if (idx === 4) return;
                
                if (selected === null) {
                    setSelected(idx);
                } else if (selected === idx) {
                    setSelected(null);
                } else {
                    const newGrid = [...grid];
                    [newGrid[selected], newGrid[idx]] = [newGrid[idx], newGrid[selected]];
                    
                    const newHistory = history.slice(0, historyIdx + 1);
                    newHistory.push(newGrid);
                    setHistory(newHistory);
                    setHistoryIdx(historyIdx + 1);
                    
                    setGrid(newGrid);
                    setSelected(null);
                    setMoves(moves + 1);
                    
                    const sol = puzzle.solutions[0];
                    const quadrantSpecs = [
                        { positions: [0, 1, 3, 4], theme: puzzle.quadrantClues[0].clue },
                        { positions: [1, 2, 4, 5], theme: puzzle.quadrantClues[1].clue },
                        { positions: [3, 4, 6, 7], theme: puzzle.quadrantClues[2].clue },
                        { positions: [4, 5, 7, 8], theme: puzzle.quadrantClues[3].clue }
                    ];

                    const currentSolvedThemes = quadrantSpecs
                        .filter(q => q.positions.every(p => newGrid[p] === sol[p]))
                        .map(q => q.theme);

                    const newThemes = currentSolvedThemes.filter(t => !solvedQuadrantOrder.includes(t));
                    const stillSolvedThemes = solvedQuadrantOrder.filter(t => currentSolvedThemes.includes(t));

                    if (newThemes.length > 0 || stillSolvedThemes.length !== solvedQuadrantOrder.length) {
                        setSolvedQuadrantOrder([...stillSolvedThemes, ...newThemes]);
                    }
                }
            };

            const solve = () => {
                setGrid(puzzle.solutions[0]);
                setSolved(true);
                setSelected(null);
                setShowThemes(true);
                setSolutionIndex(0);
                setUserSolutionIndex(null);
                setTimerActive(false);
            };

            const reset = () => {
                const shuffled = deterministicShuffle();
                setGrid(shuffled);
                setHistory([shuffled]);
                setHistoryIdx(0);
                setSolved(false);
                setSelected(null);
                setMoves(0);
                setShowThemes(true);
                setSolutionIndex(0);
                setUserSolutionIndex(null);
                setSolvedQuadrantOrder([]);
                setTimer(0);
                setTimerActive(true);
            };

            const undo = () => {
                if (historyIdx > 0) {
                    const newIdx = historyIdx - 1;
                    const undoneGrid = history[newIdx];
                    setHistoryIdx(newIdx);
                    setGrid(undoneGrid);
                    setSelected(null);
                    setMoves(Math.max(0, moves - 1));
                    
                    const sol = puzzle.solutions[0];
                    const quadrantSpecs = [
                        { positions: [0, 1, 3, 4], theme: puzzle.quadrantClues[0].clue },
                        { positions: [1, 2, 4, 5], theme: puzzle.quadrantClues[1].clue },
                        { positions: [3, 4, 6, 7], theme: puzzle.quadrantClues[2].clue },
                        { positions: [4, 5, 7, 8], theme: puzzle.quadrantClues[3].clue }
                    ];

                    const stillSolvedThemes = quadrantSpecs
                        .filter(q => q.positions.every(p => undoneGrid[p] === sol[p]))
                        .map(q => q.theme);

                    setSolvedQuadrantOrder(solvedQuadrantOrder.filter(t => stillSolvedThemes.includes(t)));
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-4">
                    <div className="max-w-md mx-auto">
                        <div className="flex items-center justify-between mb-3 px-1">
                            <div className="flex items-center gap-2 min-w-0">
                                <span className="text-xl">{puzzle.titleIcon}</span>
                                <span className="text-white font-bold truncate">{puzzle.title}</span>
                            </div>
                            <div className="text-white/60 text-sm shrink-0">#{puzzleIdx + 1}</div>
                        </div>

                        {/* Welcome / Help Modal */}
                        {showHelp && (
                            <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-50">
                                <div className="bg-white rounded-3xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto relative">
                                    <button 
                                        onClick={() => {
                                            if (dontShowWelcome) localStorage.setItem('connectionary_v2_hide_welcome', 'true');
                                            setShowHelp(false);
                                        }}
                                        className="absolute top-4 right-4 w-10 h-10 flex items-center justify-center bg-gray-200 hover:bg-gray-300 rounded-full text-gray-600 font-bold text-xl">
                                        Ã—
                                    </button>
                                    
                                    <div className="text-center mb-6">
                                        <h1 className="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-2">Associology</h1>
                                        <p className="text-gray-500 text-sm font-medium">The Word Association Puzzle</p>
                                        <div className="mt-3 inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-50 border border-blue-200 text-blue-700 text-xs font-semibold"></div>
                                    </div>

                                    <div className="mb-6">
                                        <h2 className="text-lg font-bold text-gray-800 mb-3">ðŸŽ¯ What Is It?</h2>
                                        <p className="text-gray-700 leading-relaxed text-sm mb-3">Arrange 9 words in a 3Ã—3 grid. The grid cells are numbered <strong>1â€“9</strong>. The four Theme Panels at the top tell you exactly which numbers belong to each theme.</p>
                                        
                                        <div className="mt-3 p-3 bg-blue-50 rounded-xl border border-blue-100 text-blue-900 font-medium text-sm">
                                            <strong>Example:</strong><br/>
                                            If a theme says <strong>[1-2-4-5]</strong>, you must place the 4 words for that theme into grid slots 1, 2, 4, and 5.
                                        </div>
                                    </div>

                                    <div className="mb-6">
                                        <h2 className="text-lg font-bold text-gray-800 mb-3">ðŸ‘ï¸ Preview: Puzzle #1</h2>
                                        <div className="bg-gradient-to-br from-amber-50 to-amber-100 rounded-2xl p-4 border-2 border-amber-300">
                                            {/* Header Mockup for Preview */}
                                            <div className="grid grid-cols-2 gap-2 mb-3">
                                                <div className="p-2 rounded border bg-gray-50 border-gray-200 flex items-center gap-1 relative overflow-hidden">
                                                    <span className="text-lg">ðŸš—</span>
                                                    <span className="font-bold text-[10px]">VEHICLES</span>
                                                    <div className="header-number-grid"><div>1</div><div>2</div><div>4</div><div>5</div></div>
                                                </div>
                                                <div className="p-2 rounded border bg-gray-50 border-gray-200 flex items-center gap-1 relative overflow-hidden">
                                                    <span className="text-lg">ðŸ’»</span>
                                                    <span className="font-bold text-[10px]">COMPUTERS</span>
                                                    <div className="header-number-grid"><div>2</div><div>3</div><div>5</div><div>6</div></div>
                                                </div>
                                                <div className="p-2 rounded border bg-gray-50 border-gray-200 flex items-center gap-1 relative overflow-hidden">
                                                    <span className="text-lg">ðŸ¤ </span>
                                                    <span className="font-bold text-[10px]">CATTLE</span>
                                                    <div className="header-number-grid"><div>4</div><div>5</div><div>7</div><div>8</div></div>
                                                </div>
                                                <div className="p-2 rounded border bg-gray-50 border-gray-200 flex items-center gap-1 relative overflow-hidden">
                                                    <span className="text-lg">ðŸš«</span>
                                                    <span className="font-bold text-[10px]">REMOVAL</span>
                                                    <div className="header-number-grid"><div>5</div><div>6</div><div>8</div><div>9</div></div>
                                                </div>
                                            </div>
                                            
                                            {/* Scrambled Grid Preview */}
                                            <div className="grid grid-cols-3 gap-2 mb-3">
                                                {['REPEL', 'STEER', 'CULL', 'EJECT', 'DRIVE', 'MOUSE', 'CRASH', 'WRANGLE', 'WHEEL'].map((word, idx) => (
                                                    <div key={idx} className={`aspect-square rounded-lg flex items-center justify-center font-bold text-xs border-2 relative ${idx === 4 ? 'bg-gradient-to-br from-green-400 to-green-500 border-green-600 text-green-900' : 'bg-white border-gray-300 text-gray-800'}`}>
                                                        <span className="cell-number text-gray-500">{idx + 1}</span>
                                                        {word}
                                                    </div>
                                                ))}
                                            </div>
                                            <p className="text-xs text-gray-700 text-center leading-relaxed">The words are currently scrambled. Tap to swap them until they match the numbered themes!</p>
                                        </div>
                                    </div>

                                    <div className="mb-6">
                                        <div className="bg-gradient-to-br from-purple-100 via-pink-100 to-purple-100 rounded-2xl p-4 border-2 border-purple-300">
                                            <div className="flex items-start gap-3">
                                                <span className="text-3xl flex-shrink-0">ðŸ’¡</span>
                                                <div>
                                                    <h3 className="font-bold text-purple-900 mb-2 text-sm">Best Way to Learn:</h3>
                                                    <p className="text-gray-800 text-sm leading-relaxed">Start with Puzzle #1. Look at the <strong>numbers</strong> in the headers (e.g. 1-2-4-5). Place the 4 matching words into those numbered slots. When you get all 4 correct, the quadrant turns green.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="mb-6">
                                        <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-4 border-2 border-blue-300">
                                            <div className="flex items-start gap-3">
                                                <span className="text-3xl flex-shrink-0">ðŸ“Š</span>
                                                <div>
                                                    <h3 className="font-bold text-blue-900 mb-2 text-sm">Visual Feedback:</h3>
                                                    <div className="space-y-2">
                                                        <div className="flex items-start gap-2"><span className="text-xl">ðŸŸ©</span><p className="text-gray-800 text-sm"><strong>Green quadrant:</strong> Solved! You matched all 4 words to their numbered positions.</p></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="mb-6">
                                        <label className="flex items-center gap-3 cursor-pointer group">
                                            <input type="checkbox" checked={dontShowWelcome} onChange={(e) => setDontShowWelcome(e.target.checked)} className="w-5 h-5" />
                                            <span className="text-sm text-gray-600">Don't show this again</span>
                                        </label>
                                    </div>
                                    <div className="flex gap-3">
                                        <button onClick={() => { if (dontShowWelcome) localStorage.setItem('connectionary_v2_hide_welcome', 'true'); setShowHelp(false); }} className="flex-1 bg-blue-600 text-white px-6 py-4 rounded-2xl font-bold text-lg">Start Playing!</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Themes */}
                        {showThemes && (
                            <div className="mb-4 bg-white/95 backdrop-blur rounded-xl p-3">
                                <div className="grid grid-cols-2 gap-2">
                                    {(() => {
                                        const displayGrid = solved ? puzzle.solutions[solutionIndex] : grid;
                                        const themesToShow = getQuadrantCluesBySpatialPosition(displayGrid);
                                        const partialIcons = checkPartialQuadrants();
                                        
                                        return themesToShow.map((q, i) => {
                                            if (!q) return null;
                                            const key = i; 
                                            const hasIconShowing = partialIcons && Object.values(partialIcons)[i] === q.icon;
                                            
                                            return (
                                                <div key={i} className={`rounded-lg p-2 border-2 transition-all relative overflow-hidden
                                                    ${solved || hasIconShowing ? 'bg-green-50 border-green-500' :
                                                      'bg-gray-50 border-gray-200'}`}>
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-xl">{q.icon}</span>
                                                        <span className="font-bold text-xs leading-tight flex-1">{q.clue}</span>
                                                        <div className="header-number-grid">
                                                            <div>{QUADRANT_NUMBERS[i][0]}</div>
                                                            <div>{QUADRANT_NUMBERS[i][1]}</div>
                                                            <div>{QUADRANT_NUMBERS[i][2]}</div>
                                                            <div>{QUADRANT_NUMBERS[i][3]}</div>
                                                        </div>
                                                        {(solved || hasIconShowing) && <span className="text-green-600 text-sm">âœ“</span>}
                                                    </div>
                                                </div>
                                            );
                                        });
                                    })()}
                                </div>
                            </div>
                        )}

                        {/* Grid */}
                        <div className="bg-white rounded-2xl p-4 shadow-2xl relative">
                            <div className="grid grid-cols-3 gap-3 relative">
                                {(() => {
                                    const sol = puzzle.solutions[0];
                                    const isTLSolved = grid.length > 0 && [0, 1, 3, 4].every(i => grid[i] === sol[i]);
                                    const isTRSolved = grid.length > 0 && [1, 2, 4, 5].every(i => grid[i] === sol[i]);
                                    const isBLSolved = grid.length > 0 && [3, 4, 6, 7].every(i => grid[i] === sol[i]);
                                    const isBRSolved = grid.length > 0 && [4, 5, 7, 8].every(i => grid[i] === sol[i]);
                                    
                                    return (
                                        <>
                                            {isTLSolved && (
                                                <div className="absolute top-[33.33%] left-[33.33%] -translate-x-1/2 -translate-y-1/2 z-20 text-4xl quadrant-icon-appear bg-white rounded-full p-2" style={{animationDelay: '0ms'}}>
                                                    {puzzle.quadrantClues[0].icon}
                                                </div>
                                            )}
                                            {isTRSolved && (
                                                <div className="absolute top-[33.33%] left-[66.66%] -translate-x-1/2 -translate-y-1/2 z-20 text-4xl quadrant-icon-appear bg-white rounded-full p-2" style={{animationDelay: '0ms'}}>
                                                    {puzzle.quadrantClues[1].icon}
                                                </div>
                                            )}
                                            {isBLSolved && (
                                                <div className="absolute top-[66.66%] left-[33.33%] -translate-x-1/2 -translate-y-1/2 z-20 text-4xl quadrant-icon-appear bg-white rounded-full p-2" style={{animationDelay: '0ms'}}>
                                                    {puzzle.quadrantClues[2].icon}
                                                </div>
                                            )}
                                            {isBRSolved && (
                                                <div className="absolute top-[66.66%] left-[66.66%] -translate-x-1/2 -translate-y-1/2 z-20 text-4xl quadrant-icon-appear bg-white rounded-full p-2" style={{animationDelay: '0ms'}}>
                                                    {puzzle.quadrantClues[3].icon}
                                                </div>
                                            )}
                                        </>
                                    );
                                })()}
                                
                                {(() => {
                                    const partialIcons = checkPartialQuadrants();
                                    
                                    return grid.map((word, idx) => {
                                        const isCenter = idx === 4;
                                        const isSelected = selected === idx;
                                        const inTopLeft = [0, 1, 3, 4].includes(idx);
                                        const inTopRight = [1, 2, 4, 5].includes(idx);
                                        const inBottomLeft = [3, 4, 6, 7].includes(idx);
                                        const inBottomRight = [4, 5, 7, 8].includes(idx);
                                        
                                        const inGreenQuadrant = partialIcons && (
                                            (inTopLeft && partialIcons.tl) ||
                                            (inTopRight && partialIcons.tr) ||
                                            (inBottomLeft && partialIcons.bl) ||
                                            (inBottomRight && partialIcons.br)
                                        );
                                        
                                        const progressiveDefinition = !solved ? getVisibleDefinitions(word) : null;
                                        const hasProgressiveDefinition = progressiveDefinition !== null;
                                        
                                        return (
                                            <div key={idx} onClick={() => handleCellClick(idx)}
                                                className={`aspect-square rounded-xl border-4 flex flex-col items-center justify-center transition-all relative
                                                    ${(solved || hasProgressiveDefinition) ? 'py-1 px-1' : 'py-4'}
                                                    ${isCenter ? 'locked-cell border-green-500 cursor-not-allowed' : 
                                                      isSelected ? 'cell-selected' :
                                                      solved ? 'bg-green-50 border-green-400' :
                                                      inGreenQuadrant ? 'bg-green-50 border-green-400' :
                                                      'bg-gray-50 border-gray-400 cursor-pointer active:scale-95'}`}>
                                                
                                                <span className={`cell-number ${isCenter ? 'text-green-900' : 'text-gray-600'}`}>{idx + 1}</span>

                                                {isCenter && (
                                                    <div className="absolute -top-2 -right-2 bg-green-600 rounded-full p-1 z-10">
                                                        <svg className="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd" /></svg>
                                                    </div>
                                                )}
                                                <div className={`font-bold ${getFontSize(word)} text-center px-0.5 leading-tight ${isCenter ? 'text-green-900' : solved ? 'text-green-800' : isSelected ? 'text-white' : 'text-gray-800'}`}>
                                                    {getDisplayWord(word)}
                                                </div>
                                                {(solved || hasProgressiveDefinition) && (
                                                    <div className={`text-[10px] text-center mt-0.5 leading-[1.2] px-0.5 w-full ${hasProgressiveDefinition && !solved ? 'text-green-700' : 'text-gray-600'}`}>
                                                        {hasProgressiveDefinition ? progressiveDefinition : getFullDefinition(word)}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    });
                                })()}
                            </div>
                        </div>

                        <div className="mt-4 flex flex-col gap-2">
                            <div className="flex gap-2">
                                <button onClick={undo} disabled={historyIdx <= 0 || solved} className="flex-1 py-3 bg-white/20 rounded-lg text-white font-bold disabled:opacity-30 active:scale-95 transition-transform">Undo</button>
                                <button onClick={reset} className="flex-1 py-3 bg-white/20 rounded-lg text-white font-bold active:scale-95 transition-transform">Reset</button>
                                <button onClick={solve} className="flex-1 py-3 bg-white/20 rounded-lg text-white font-bold active:scale-95 transition-transform">Solve</button>
                                <button onClick={() => setShowHelp(true)} className="flex-1 py-3 bg-blue-500/80 rounded-lg text-white font-bold active:scale-95 transition-transform">Help</button>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setPuzzleIdx(Math.max(0, puzzleIdx - 1))} disabled={puzzleIdx === 0} className="flex-1 py-3 bg-slate-700 rounded-lg text-white font-bold disabled:opacity-30 active:scale-95 transition-transform">â† Prev</button>
                                <button onClick={() => setShowGallery(true)} className="flex-1 py-3 bg-slate-700 rounded-lg text-white font-bold active:scale-95 transition-transform">Gallery</button>
                                <button onClick={() => setPuzzleIdx(Math.min(PUZZLES.length - 1, puzzleIdx + 1))} disabled={puzzleIdx === PUZZLES.length - 1} className="flex-1 py-3 bg-slate-700 rounded-lg text-white font-bold disabled:opacity-30 active:scale-95 transition-transform">Next â†’</button>
                            </div>
                        </div>

                        {showGallery && (
                            <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50" onClick={() => setShowGallery(false)}>
                                <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6" onClick={e => e.stopPropagation()}>
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-2xl font-bold text-gray-800">Puzzle Gallery</h2>
                                        <button onClick={() => setShowGallery(false)} className="w-10 h-10 flex items-center justify-center bg-gray-200 rounded-full font-bold text-xl">Ã—</button>
                                    </div>
                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                        {PUZZLES.map((p, idx) => {
                                            const isSolved = solvedPuzzles[p.id];
                                            const isCurrent = idx === puzzleIdx;
                                            return (
                                                <button key={p.id} onClick={() => { setPuzzleIdx(idx); setShowGallery(false); }} className={`relative p-4 rounded-xl border-2 text-left ${isCurrent ? 'border-blue-500 bg-blue-50' : isSolved ? 'border-green-300 bg-green-50' : 'border-gray-300 bg-white'}`}>
                                                    {isSolved && <div className="absolute top-2 right-2 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-sm">âœ“</div>}
                                                    <div className="text-3xl mb-2">{p.titleIcon}</div>
                                                    <div className="font-bold text-sm text-gray-800 mb-1">{p.title}</div>
                                                    <div className="text-xs text-gray-500">#{idx + 1}</div>
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
